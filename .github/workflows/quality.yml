name: Quality

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "**" ]
        types: [ opened, synchronize, reopened, ready_for_review ]
    workflow_dispatch:

jobs:
    phpstan:
        name: PHPStan (max + custom rules)
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'

            -   name: Run PHPStan with custom decimal arithmetic rules
                run: |
                    echo "ðŸ” Running PHPStan at max level with custom rules:"
                    composer phpstan

    psalm:
        name: Psalm (strict)
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'

            -   name: Run Psalm in strict mode
                run: composer psalm

    php-cs-fixer:
        name: PHP-CS-Fixer
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'

            -   name: Run php-cs-fixer dry-run
                run: vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php --dry-run --diff

    infection:
        name: Infection
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'
                    coverage: xdebug

            -   name: Run Infection with coverage thresholds
                run: composer infection -- --log-verbosity=none

    phpbench:
        name: PhpBench
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'

            -   name: Run PhpBench regression suite
                run: >-
                    php -d memory_limit=-1 -d xdebug.mode=off vendor/bin/phpbench run
                    --config=phpbench.json
                    --ref=baseline
                    --progress=plain
                    --assert="mean(variant.time.avg) <= mean(baseline.time.avg) +/- 20%"
                    --assert="mean(variant.mem.peak) <= mean(baseline.mem.peak) +/- 30%"

    artefacts:
        name: Docs & performance artefacts
        runs-on: ubuntu-latest
        needs:
            - phpbench
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: '8.3'
                    ini_values: 'memory_limit=-1'
                    coverage: xdebug

            -   name: Generate API documentation
                run: composer phpdoc
            -   name: Upload PHPDoc artefact
                uses: actions/upload-artifact@v6
                with:
                    name: phpdoc-md
                    path: docs/api
                    if-no-files-found: error
            -   name: Prepare PhpBench artefact bundle
                run: |
                    set -o pipefail
                    mkdir -p build/phpbench
                    cp -R .phpbench/storage build/phpbench/
                    php -d memory_limit=-1 -d xdebug.mode=off vendor/bin/phpbench run \
                      --config=phpbench.json \
                      --ref=baseline \
                      --progress=plain \
                      --report=p2p_aggregate \
                      --iterations=1 \
                      --revs=1 | tee build/phpbench/p2p_aggregate.txt
            -   name: Upload PhpBench artefact
                uses: actions/upload-artifact@v6
                with:
                    name: phpbench-baseline
                    path: build/phpbench
                    if-no-files-found: error
            -   name: Generate hotspot profiling traces
                run: |
                    rm -rf .xdebug
                    mkdir -p .xdebug
                    php -d xdebug.mode=profile \
                      -d xdebug.start_with_request=yes \
                      -d xdebug.output_dir=.xdebug \
                      vendor/bin/phpbench run \
                        --config=phpbench.json \
                        --report=p2p_aggregate \
                        --filter=benchFindBottleneckMandatoryMinima \
                        --iterations=1 \
                        --revs=1
                    mkdir -p build/profiling
                    find .xdebug -type f -name 'cachegrind.out.*' -exec cp {} build/profiling/ \;
            -   name: Upload profiling artefact
                uses: actions/upload-artifact@v6
                with:
                    name: hotspot-profiles
                    path: build/profiling
                    if-no-files-found: error
