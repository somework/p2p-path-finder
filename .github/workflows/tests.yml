name: Tests

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "**" ]
        types: [ opened, synchronize, reopened, ready_for_review ]
    workflow_dispatch:

jobs:
    phpunit:
        name: PHPUnit (PHP ${{ matrix.php-version }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: true
            matrix:
                php-version: [ '8.2', '8.3', '8.4' ]

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6

            -   name: Install dependencies
                uses: ./.github/actions/composer-install
                with:
                    php-version: ${{ matrix.php-version }}
                    ini_values: 'memory_limit=-1'
                    coverage: xdebug

            -   name: Run PHPUnit with coverage
                run: |
                    mkdir -p coverage
                    vendor/bin/phpunit --coverage-clover=coverage/clover.xml

            -   name: Upload coverage artifact
                uses: actions/upload-artifact@v6
                with:
                    name: coverage-php${{ matrix.php-version }}
                    path: coverage/clover.xml
                    if-no-files-found: error
                    retention-days: 7
